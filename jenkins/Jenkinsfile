pipeline {
    agent any
     tools {
        jdk 'OpenJDK-17'     
        maven 'Maven-3.9.6'   
    }
    options {
        skipStagesAfterUnstable()
    }
     environment {
            // JFROG_M2_REPO='opsera_customer1_m2'
            // JFROG_URL='https://trial28qn92.jfrog.io/artifactory'
            // JFROG_RELEASE_REPO='opsera_customer1_release'
            // JFROG_TEST_REPORT_REPO='opsera_customer1_test_report'
            JFROG_TEST_REPORT_PASSWORD = credentials('JFROG_TEST_REPORT_PASSWORD') // Best practice to use credstore
            JFROG_USERNAME = credentials('JFROG_USERNAME') // Best practice to use credstore
            JFROG_RELEASE_PASSWORD = credentials('JFROG_RELEASE_PASSWORD') // Best practice to use credstore
            JFROG_M2_PASSWORD = credentials('JFROG_M2_PASSWORD') // Best practice to use credstore
        }
    stages {
        stage('Load .env') {
            steps {
                script {
                    // Read .env into a map manually
                    def envContent = readFile('.env')
                    envContent.split('\n').each { line ->
                        line = line.trim()
                        if (line && !line.startsWith('#')) {
                            def (key, value) = line.split('=', 2)
                            env[key.trim()] = value.trim()
                        }
                    }
                }
            }
        }


        stage('Build') {
            steps {
                //sh 'mvn -B -DskipTests clean package'
                sh 'echo ${env.JFROG_M2_REPO}'
                sh 'mvn -B -DskipTests clean deploy'
            }
        }
        stage('Test') {
            steps {
                sh 'mvn test'
            }
            post {
                always {
                    junit 'target/surefire-reports/*.xml'
                    // Archive test result files for download
                    archiveArtifacts artifacts: 'target/surefire-reports/*.xml', fingerprint: true
                    script {
                    def TIMESTAMP = new Date().format('yyyyMMdd_HHmmss')
                    sh """
                        curl -u "${env.JFROG_USERNAME}:${env.JFROG_TEST_REPORT_PASSWORD}" \
                        -T target/surefire-reports/*.xml \
                        "${env.JFROG_URL}/${env.JFROG_TEST_REPORT_REPO}/com.mycompany.app.AppTest.${TIMESTAMP}.xml"
                    """
            }
            }
        }
        }
        stage('Deliver') { 
            steps {
                sh './jenkins/scripts/deliver.sh' 
            }
        }
    }
}
